<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â™¦ï¸K - ç¾äººæŠ•ç¥¨ (å¤šäººé€£ç·šç‰ˆ)</title>
    <style>
        :root{--primary-bg:#121212;--secondary-bg:#1e1e1e;--border-color:#444;--text-color:#e0e0e0;--accent-color:#e60000;--host-color:#ffd700}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background-color:var(--primary-bg);color:var(--text-color);margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:1em;box-sizing:border-box}
        #game-wrapper{position:relative;width:100%;max-width:900px;background-color:var(--secondary-bg);border:2px solid var(--border-color);border-radius:15px;padding:2em;text-align:center}
        .screen{display:none}.screen.active{display:block}
        button{background-color:var(--accent-color);color:#fff;border:none;padding:10px 20px;border-radius:5px;font-size:1.2em;cursor:pointer;transition:background-color .2s}
        button:hover:not(:disabled){background-color:#c40000} button:disabled{background-color:#555;cursor:not-allowed}
        #lobby-players{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}
        .player-card{background-color:var(--primary-bg);padding:15px;border-radius:8px;border:1px solid var(--border-color)}.player-card.is-host .player-name::after{content:'ğŸ‘‘';margin-left:8px;color:var(--host-color)}.player-card.is-eliminated{opacity:.5;text-decoration:line-through}.player-score{font-size:1.5em;font-weight:700}
        #timer{font-size:2.5em;color:var(--accent-color);font-weight:700;margin-bottom:20px}
        #number-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:5px;max-width:600px;margin:0 auto}.number-btn{background-color:#333;padding:8px;font-size:1em;border-radius:4px}.number-btn.selected{background-color:var(--host-color);color:#111}
        #results-list,#scoreboard-list{list-style:none;padding:0;max-width:500px;margin:20px auto}#results-list li,#scoreboard-list li{background-color:var(--primary-bg);margin-bottom:10px;padding:15px;border-radius:5px;display:flex;justify-content:space-between;font-size:1.2em}
        #notification-overlay,#new-rule-notification,#rules-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:flex;justify-content:center;align-items:center;text-align:center;flex-direction:column;z-index:100;opacity:0;pointer-events:none;transition:opacity .5s}
        #notification-overlay.visible,#new-rule-notification.visible,#rules-modal-overlay.visible{opacity:1;pointer-events:auto}
        #new-rule-notification h2{color:var(--accent-color);font-size:2.5em;margin-bottom:1em}#new-rule-notification ul{list-style:none;padding:0;font-size:1.5em}
        
        /* ** å…¨æ–°çš„è¦å‰‡æ¨¡æ…‹è¦–çª— CSS ** */
        #rules-modal{background-color:var(--secondary-bg);padding:2em 3em;border-radius:15px;width:90%;max-width:600px;text-align:left;position:relative;border:1px solid var(--border-color)}
        #rules-modal h2{text-align:center;margin-top:0;color:var(--accent-color)}
        #rules-modal .rule-item h3{margin-bottom:.5em;color:var(--host-color)}#rules-modal .rule-item p{margin-top:0;color:#ccc;line-height:1.6}
        #close-rules-btn{position:absolute;top:15px;right:20px;font-size:2em;background:0 0;padding:0;border:none;cursor:pointer;color:#888;line-height:1}
        #show-rules-btn{position:absolute;top:20px;right:20px;background-color:#333;font-size:1em;padding:8px 15px}
    </style>
</head>
<body>

    <div id="game-wrapper">
        <button id="show-rules-btn">è¦å‰‡æ‰‹å†Š</button>

        <div id="lobby-screen" class="screen active"> <h1 id="lobby-title">ç­‰å¾…ç©å®¶åŠ å…¥...</h1> <div id="lobby-players"></div> <button id="start-game-btn" disabled>ç­‰å¾…ä¸»æŒäººé–‹å§‹éŠæˆ²</button> </div>
        <div id="game-screen" class="screen"> <h2 id="round-title"></h2> <div id="timer">03:00</div> <div id="number-grid"></div> </div>
        <div id="spectator-screen" class="screen"> <h2>æ‚¨å·²è¢«æ·˜æ±°</h2> <p>è«‹éœå¾…éŠæˆ²çµæŸã€‚</p> </div>
        <div id="results-screen" class="screen"> <h2>å›åˆçµæœ</h2> <p>ç›®æ¨™æ•¸å­—: <strong id="target-number"></strong></p> <p>å‹åˆ©è€…: <strong id="winner-name"></strong></p> <ul id="results-list"></ul> <div id="elimination-message"></div> <button id="next-round-btn">æŸ¥çœ‹è¨ˆåˆ†æ¿</button> </div>
        <div id="scoreboard-screen" class="screen"> <h2>è¨ˆåˆ†æ¿</h2> <ul id="scoreboard-list"></ul> <p>10ç§’å¾Œé–‹å§‹ä¸‹ä¸€è¼ª...</p> </div>
        <div id="game-over-screen" class="screen"> <h2>éŠæˆ²çµæŸ</h2> <p>æœ€çµ‚å‹åˆ©è€…æ˜¯: <strong id="final-winner"></strong></p> </div>
    </div>

    <!-- å„ç¨®å…¨è¢å¹•é€šçŸ¥ -->
    <div id="notification-overlay"><span></span></div>
    <div id="new-rule-notification"> <h2>æ–°è¦å‰‡å·²å•Ÿå‹•</h2> <ul id="new-rule-list"></ul> </div>
    
    <!-- ** å…¨æ–°çš„è¦å‰‡æ¨¡æ…‹è¦–çª— HTML ** -->
    <div id="rules-modal-overlay">
        <div id="rules-modal">
            <button id="close-rules-btn">&times;</button>
            <h2>éŠæˆ²è¦å‰‡</h2>
            <div class="rule-item">
                <h3>åŸºç¤è¦å‰‡</h3>
                <p>æ‰€æœ‰ç©å®¶å¾ 0-100 é¸æ“‡ä¸€å€‹æ•¸å­—ã€‚ç³»çµ±è¨ˆç®—å¹³å‡æ•¸ x 0.8 ä½œç‚ºç›®æ¨™ï¼Œæœ€æ¥è¿‘è€…ç²å‹ï¼Œå…¶é¤˜ç©å®¶æ‰£ 1 åˆ†ã€‚åˆ†æ•¸é” -10 å‰‡æ·˜æ±°ã€‚</p>
            </div>
            <div class="rule-item" data-rule="HIGH_NUMBER_GAMBIT">
                <h3>ç‰¹æ®Šè¦å‰‡ï¼šé«˜é¡è±å… (äººæ•¸ > 2)</h3>
                <p>è‹¥åƒ…æœ‰ä¸€åç©å®¶é¸æ“‡ â‰¥75 çš„æ•¸å­—ï¼Œè©²ç©å®¶æœ¬å›åˆå…ç–«æ‰£åˆ†ä¸¦ +0.5 åˆ†ã€‚è‹¥æœ‰å¤šåç©å®¶é¸æ“‡ â‰¥75ï¼Œå‰‡æ­¤è¦å‰‡å°æ‰€æœ‰äººéƒ½ç„¡æ•ˆã€‚</p>
            </div>
            <div class="rule-item" data-rule="TIE_INVALID">
                <h3>è¿½åŠ è¦å‰‡ä¸€ï¼šåŒç¥¨ç„¡æ•ˆ (äººæ•¸ â‰¤ 4)</h3>
                <p>è‹¥æœ‰å…©åæˆ–ä»¥ä¸Šç©å®¶é¸æ“‡ç›¸åŒæ•¸å­—ï¼Œä»–å€‘çš„é¸æ“‡å°‡è¢«è¦–ç‚ºç„¡æ•ˆï¼Œç„¡æ³•ç²å‹ã€‚</p>
            </div>
            <div class="rule-item" data-rule="DOUBLE_PENALTY">
                <h3>è¿½åŠ è¦å‰‡äºŒï¼šç²¾æº–æ‡²ç½° (äººæ•¸ â‰¤ 3)</h3>
                <p>è‹¥å‹åˆ©è€…é¸æ“‡çš„æ•¸å­—æ°å¥½ç­‰æ–¼å››æ¨äº”å…¥å¾Œçš„ç›®æ¨™æ•¸å­—ï¼Œæ‰€æœ‰å¤±æ•—è€…å°‡è¢«æ‰£ 2 åˆ†ã€‚</p>
            </div>
            <div class="rule-item" data-rule="ZERO_VS_HUNDRED">
                <h3>è¿½åŠ è¦å‰‡ä¸‰ï¼šçµ‚æ¥µå°æ±º (äººæ•¸ = 2)</h3>
                <p>è‹¥å…©åç©å®¶åˆ†åˆ¥é¸æ“‡ 0 å’Œ 100ï¼Œå‰‡é¸æ“‡ 100 çš„ç©å®¶ç›´æ¥ç²å‹ã€‚</p>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- å…ƒç´ é¸æ“‡ ---
        const socket = io();
        const screens = { lobby: document.getElementById('lobby-screen'), game: document.getElementById('game-screen'), spectator: document.getElementById('spectator-screen'), results: document.getElementById('results-screen'), scoreboard: document.getElementById('scoreboard-screen'), gameOver: document.getElementById('game-over-screen') };
        const showRulesBtn = document.getElementById('show-rules-btn'), closeRulesBtn = document.getElementById('close-rules-btn'), rulesModalOverlay = document.getElementById('rules-modal-overlay');
        const notificationOverlay = document.getElementById('notification-overlay'), notificationText = notificationOverlay.querySelector('span'), newRuleNotification = document.getElementById('new-rule-notification'), newRuleList = document.getElementById('new-rule-list');
        
        let roomCode = sessionStorage.getItem('gameRoomCode'), playerName = sessionStorage.getItem('playerName');
        
        // --- è¦å‰‡èªªæ˜æ˜ å°„ ---
        const RULE_DESCRIPTIONS = {
            'HIGH_NUMBER_GAMBIT': 'ç‰¹æ®Šè¦å‰‡ï¼šé«˜é¡è±å…',
            'TIE_INVALID': 'è¿½åŠ è¦å‰‡ä¸€ï¼šåŒç¥¨ç„¡æ•ˆ',
            'DOUBLE_PENALTY': 'è¿½åŠ è¦å‰‡äºŒï¼šç²¾æº–æ‡²ç½°',
            'ZERO_VS_HUNDRED': 'è¿½åŠ è¦å‰‡ä¸‰ï¼šçµ‚æ¥µå°æ±º'
        };

        // --- åˆå§‹åŒ– & åŠ å…¥æˆ¿é–“ ---
        if (!roomCode || !playerName) {
            playerName = prompt("è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±:") || `ç©å®¶${Math.floor(Math.random() * 1000)}`;
            roomCode = prompt("è«‹è¼¸å…¥æˆ¿é–“ä»£ç¢¼:") || "default";
            sessionStorage.setItem('playerName', playerName); sessionStorage.setItem('gameRoomCode', roomCode);
        }
        socket.emit('joinRoom', { roomCode, playerName });
        createNumberGrid();
        
        // --- Socket äº‹ä»¶ç›£è½ ---
        socket.on('updateGameState', (newState) => { updateUI(newState); });
        socket.on('startRound', ({ round, duration, activeRules }) => {
            newRuleNotification.classList.remove('visible');
            document.getElementById('round-title').textContent = `ç¬¬ ${round} å›åˆ`;
            updateActiveRulesUI(activeRules); // æ›´æ–°è¦å‰‡UI
            startClientTimer(duration);
            resetNumberGrid();
        });
        socket.on('newRulesAdded', (addedRules) => {
            newRuleList.innerHTML = '';
            addedRules.forEach(code => newRuleList.innerHTML += `<li>${RULE_DESCRIPTIONS[code] || code}</li>`);
            newRuleNotification.classList.add('visible');
        });
        socket.on('showAllVoted', () => { showNotification("æ‰€æœ‰ç©å®¶å·²æŠ•ç¥¨", 5000); });

        // --- UI äº‹ä»¶ç›£è½ ---
        showRulesBtn.addEventListener('click', () => rulesModalOverlay.classList.add('visible'));
        closeRulesBtn.addEventListener('click', () => rulesModalOverlay.classList.remove('visible'));
        document.getElementById('start-game-btn').addEventListener('click', () => socket.emit('startGame', roomCode));
        document.getElementById('next-round-btn').addEventListener('click', () => socket.emit('nextRound', roomCode));

        // --- UI æ›´æ–°å‡½æ•¸ ---
        function updateUI(gameState) {
            const myPlayer = gameState.players ? gameState.players[socket.id] : null;
            switch(gameState.status) {
                case 'LOBBY': switchScreen('lobby'); updateLobbyUI(gameState, roomCode); break;
                case 'PLAYING': if(myPlayer && myPlayer.isEliminated) { switchScreen('spectator'); } else { switchScreen('game'); } break;
                case 'RESULTS': switchScreen('results'); updateResultsUI(gameState); break;
                case 'SCOREBOARD': switchScreen('scoreboard'); updateScoreboardUI(gameState); break;
                case 'GAME_OVER': switchScreen('gameOver'); document.getElementById('final-winner').textContent = Object.values(gameState.players).find(p=>!p.isEliminated)?.name || 'ç„¡'; break;
            }
        }
        function updateLobbyUI(gameState, roomCode){ /* ... çœç•¥è©³ç´°å¯¦ç¾ ... */ document.getElementById('lobby-title').textContent=`æˆ¿é–“: ${roomCode}`;renderPlayerList(document.getElementById('lobby-players'),gameState.players,gameState.hostId);const startBtn=document.getElementById('start-game-btn');if(socket.id===gameState.hostId){startBtn.textContent='é–‹å§‹éŠæˆ²';startBtn.disabled=Object.keys(gameState.players).length<2}else{startBtn.textContent='ç­‰å¾…ä¸»æŒäºº';startBtn.disabled=!0}}
        function updateResultsUI(gameState){ /* ... çœç•¥è©³ç´°å¯¦ç¾ ... */ const res=gameState.lastRoundResult;document.getElementById('target-number').textContent=res.target;document.getElementById('winner-name').textContent=res.winnerName;const list=document.getElementById('results-list');list.innerHTML='';res.choices.forEach(c=>{list.innerHTML+=`<li><span>${c.playerName}</span><strong>${c.choice}</strong></li>`});document.getElementById('elimination-message').innerHTML=res.eliminatedPlayers.length>0?`<p style="color:var(--accent-color);">æ·˜æ±°: ${res.eliminatedPlayers.join(', ')}</p>`:'';document.getElementById('next-round-btn').style.display=socket.id===gameState.hostId?'block':'none'}
        function updateScoreboardUI(gameState){ renderPlayerList(document.getElementById('scoreboard-list'),gameState.players,gameState.hostId); }
        function renderPlayerList(container, players, hostId){ container.innerHTML='';Object.values(players).sort((a,b)=>b.score-a.score).forEach(p=>{const c=document.createElement('div');c.className='player-card';p.id===hostId&&c.classList.add('is-host');p.isEliminated&&c.classList.add('is-eliminated');c.innerHTML=`<div class="player-name">${p.name}</div><div class="player-score">${p.score}</div>`;container.appendChild(c)}) }
        function updateActiveRulesUI(activeRules) {
            document.querySelectorAll('#rules-modal .rule-item').forEach(el => {
                el.style.display = activeRules.includes(el.dataset.rule) ? 'block' : 'none';
            });
            document.querySelector('#rules-modal .rule-item:not([data-rule])').style.display = 'block'; // Always show basic rule
        }
        function showNotification(msg, dur){ notificationText.textContent = msg; notificationOverlay.classList.add('visible'); setTimeout(() => notificationOverlay.classList.remove('visible'), dur); }
        function switchScreen(id){Object.values(screens).forEach(s=>s.classList.remove('active'));if(screens[id])screens[id].classList.add('active');}
        let roundTimerInterval; function startClientTimer(d){let t=d;clearInterval(roundTimerInterval);roundTimerInterval=setInterval(()=>{t-=1e3;const m=Math.floor(t/6e4),s=Math.floor(t/1e3%60);document.getElementById('timer').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;if(t<=0)clearInterval(roundTimerInterval)},1e3)}
        function createNumberGrid(){const g=document.getElementById('number-grid');for(let i=0;i<=100;i++){const b=document.createElement('button');b.className='number-btn';b.textContent=i;b.addEventListener('click',()=>{if(b.disabled)return;socket.emit('submitNumber',{roomCode,number:i});document.querySelectorAll('.number-btn').forEach(btn=>btn.disabled=true);b.classList.add('selected')});g.appendChild(b)}}
        function resetNumberGrid(){document.querySelectorAll('.number-btn').forEach(b=>{b.disabled=false;b.classList.remove('selected')})}
    });
    </script>
</body>
</html>
