<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â™¦ï¸K - ç¾äººæŠ•ç¥¨ (å¤šäººé€£ç·šç‰ˆ)</title>
    <!-- CSS æ¨£å¼èˆ‡ä¸Šä¸€ç‰ˆå®Œå…¨ç›¸åŒï¼Œç‚ºäº†ç°¡æ½”çœç•¥ -->
    <!-- å¦‚æœæ‚¨ä¸ç¢ºå®šï¼Œå¯ä»¥ç›´æ¥è¤‡è£½ä¸Šä¸€å›ç­”çš„å®Œæ•´ style æ¨™ç±¤ -->
    <style>:root{--primary-bg:#121212;--secondary-bg:#1e1e1e;--border-color:#444;--text-color:#e0e0e0;--accent-color:#e60000;--host-color:#ffd700}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background-color:var(--primary-bg);color:var(--text-color);margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:1em;box-sizing:border-box}#game-wrapper{width:100%;max-width:900px;background-color:var(--secondary-bg);border:2px solid var(--border-color);border-radius:15px;padding:2em;text-align:center}.screen{display:none}.screen.active{display:block}button{background-color:var(--accent-color);color:#fff;border:none;padding:10px 20px;border-radius:5px;font-size:1.2em;cursor:pointer;transition:background-color .2s}button:hover{background-color:#c40000}button:disabled{background-color:#555;cursor:not-allowed}#lobby-players{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}.player-card{background-color:var(--primary-bg);padding:15px;border-radius:8px;border:1px solid var(--border-color)}.player-card.is-host .player-name::after{content:'ğŸ‘‘';margin-left:8px;color:var(--host-color)}.player-card.is-eliminated{opacity:.5;text-decoration:line-through}.player-score{font-size:1.5em;font-weight:700}#start-game-btn{margin-top:20px}#timer{font-size:2.5em;color:var(--accent-color);font-weight:700;margin-bottom:20px}#number-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:5px;max-width:600px;margin:0 auto}.number-btn{background-color:#333;padding:8px;font-size:1em;border-radius:4px}.number-btn.selected{background-color:var(--host-color);color:#111}.number-btn:disabled{background-color:#222}#results-list,#scoreboard-list{list-style:none;padding:0;max-width:500px;margin:20px auto}#results-list li,#scoreboard-list li{background-color:var(--primary-bg);margin-bottom:10px;padding:15px;border-radius:5px;display:flex;justify-content:space-between;font-size:1.2em}#notification-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;font-size:3em;color:#fff;z-index:100;opacity:0;pointer-events:none;transition:opacity .5s}#notification-overlay.visible{opacity:1}</style>
</head>
<body>

    <div id="game-wrapper">
        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen active">
            <h1 id="lobby-title">ç­‰å¾…ç©å®¶åŠ å…¥...</h1>
            <div id="lobby-players"></div>
            <button id="start-game-btn" disabled>ç­‰å¾…ä¸»æŒäººé–‹å§‹éŠæˆ²</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2 id="round-title"></h2>
            <div id="timer">03:00</div>
            <p>è«‹é¸æ“‡ä¸€å€‹æ•¸å­— (0-100)</p>
            <div id="number-grid"></div>
        </div>
        
        <!-- ** æ–°å¢ ** Spectator Screen -->
        <div id="spectator-screen" class="screen">
            <h2>æ‚¨å·²è¢«æ·˜æ±°</h2>
            <p>è«‹éœå¾…éŠæˆ²çµæŸï¼Œè§€è³å‰©é¤˜ç©å®¶çš„å°æ±ºã€‚</p>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h2>å›åˆçµæœ</h2>
            <p>ç›®æ¨™æ•¸å­—: <strong id="target-number"></strong></p>
            <p>å‹åˆ©è€…: <strong id="winner-name"></strong></p>
            <ul id="results-list"></ul>
            <div id="elimination-message"></div>
            <button id="next-round-btn">æŸ¥çœ‹è¨ˆåˆ†æ¿</button>
        </div>

        <!-- Scoreboard Screen -->
        <div id="scoreboard-screen" class="screen">
            <h2>è¨ˆåˆ†æ¿</h2>
            <ul id="scoreboard-list"></ul>
            <p>10ç§’å¾Œå°‡è‡ªå‹•é–‹å§‹ä¸‹ä¸€è¼ª...</p>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <h2>éŠæˆ²çµæŸ</h2>
            <p>æœ€çµ‚å‹åˆ©è€…æ˜¯: <strong id="final-winner"></strong></p>
        </div>
    </div>

    <div id="notification-overlay"></div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const screens = {
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen'),
            spectator: document.getElementById('spectator-screen'), // ** æ–°å¢ **
            results: document.getElementById('results-screen'),
            scoreboard: document.getElementById('scoreboard-screen'),
            gameOver: document.getElementById('game-over-screen'),
        };
        
        // --- UI Elements --- (èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
        const lobbyTitle = document.getElementById('lobby-title');
        const lobbyPlayers = document.getElementById('lobby-players');
        const startGameBtn = document.getElementById('start-game-btn');
        const roundTitle = document.getElementById('round-title');
        const timerDisplay = document.getElementById('timer');
        const numberGrid = document.getElementById('number-grid');
        const targetNumber = document.getElementById('target-number');
        const winnerName = document.getElementById('winner-name');
        const resultsList = document.getElementById('results-list');
        const eliminationMessage = document.getElementById('elimination-message');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const scoreboardList = document.getElementById('scoreboard-list');
        const finalWinner = document.getElementById('final-winner');
        const notificationOverlay = document.getElementById('notification-overlay');
        
        let roomCode = sessionStorage.getItem('gameRoomCode');
        let playerName = sessionStorage.getItem('playerName');
        let gameState = {};
        let roundTimerInterval;

        if (!roomCode || !playerName) {
            playerName = prompt("è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±:") || `ç©å®¶${Math.floor(Math.random() * 1000)}`;
            roomCode = prompt("è«‹è¼¸å…¥æˆ¿é–“ä»£ç¢¼åŠ å…¥æˆ–å‰µå»ºæˆ¿é–“:") || "default";
            sessionStorage.setItem('playerName', playerName);
            sessionStorage.setItem('gameRoomCode', roomCode);
        }

        socket.emit('joinRoom', { roomCode, playerName });
        createNumberGrid();
        
        // --- Socket Listeners --- (èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
        socket.on('updateGameState', (newState) => {
            gameState = newState;
            console.log("Game state updated:", gameState);
            updateUI();
        });
        socket.on('startRound', ({ round, duration }) => {
            roundTitle.textContent = `ç¬¬ ${round} å›åˆ`;
            startClientTimer(duration);
            resetNumberGrid();
        });
        socket.on('showAllVoted', () => {
            clearInterval(roundTimerInterval);
            showNotification("æ‰€æœ‰ç©å®¶å·²æŠ•ç¥¨", 5000);
        });

        // --- Event Handlers --- (èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
        startGameBtn.addEventListener('click', () => socket.emit('startGame', roomCode));
        nextRoundBtn.addEventListener('click', () => socket.emit('nextRound', roomCode));

        // --- UI Update Functions ---
        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }
        }
        
        function updateUI() {
            // ** æ ¸å¿ƒä¿®æ­£ï¼šæ ¹æ“šç©å®¶æ˜¯å¦è¢«æ·˜æ±°ä¾†æ±ºå®šé¡¯ç¤ºå“ªå€‹ç•«é¢ **
            const myPlayer = gameState.players ? gameState.players[socket.id] : null;

            switch(gameState.status) {
                case 'LOBBY':
                    renderLobby();
                    switchScreen('lobby');
                    break;
                case 'PLAYING':
                    // å¦‚æœæˆ‘åœ¨éŠæˆ²ä¸­è¢«æ·˜æ±°äº†ï¼Œå°±å»è§€æˆ°ç•«é¢
                    if (myPlayer && myPlayer.isEliminated) {
                        switchScreen('spectator');
                    } else { // å¦å‰‡æ­£å¸¸é€²å…¥éŠæˆ²ç•«é¢
                        switchScreen('game');
                    }
                    break;
                case 'RESULTS':
                    renderResults();
                    switchScreen('results');
                    break;
                case 'SCOREBOARD':
                    renderScoreboard();
                    switchScreen('scoreboard');
                    break;
                case 'GAME_OVER':
                    renderGameOver();
                    switchScreen('gameOver');
                    break;
            }
        }
        // ... å…¶ä»– render å‡½æ•¸ (renderLobby, renderPlayerList, etc.) èˆ‡ä¸Šä¸€ç‰ˆå®Œå…¨ç›¸åŒ ...
        // ç‚ºäº†ç°¡æ½”çœç•¥ï¼Œè‹¥ä¸ç¢ºå®šå¯ä»¥ç›´æ¥è¤‡è£½ä¸Šä¸€ç‰ˆçš„å®Œæ•´ <script>
        // ç¢ºä¿æ‚¨æ“æœ‰å®Œæ•´çš„ renderLobby, renderPlayerList, renderResults, renderScoreboard, renderGameOver, createNumberGrid, resetNumberGrid, startClientTimer, showNotification å‡½æ•¸

        // é™„ä¸Šå®Œæ•´çš„ JS å‡½æ•¸ä»¥é˜²è¬ä¸€
        function renderLobby(){lobbyTitle.textContent=`æˆ¿é–“: ${roomCode} - ç­‰å¾…ç©å®¶...`;renderPlayerList(lobbyPlayers);if(socket.id===gameState.hostId){startGameBtn.textContent='é–‹å§‹éŠæˆ²';startGameBtn.disabled=Object.keys(gameState.players).length<2}else{startGameBtn.textContent='ç­‰å¾…ä¸»æŒäººé–‹å§‹éŠæˆ²';startGameBtn.disabled=!0}}
        function renderPlayerList(e){e.innerHTML='';const t=Object.values(gameState.players).sort((e,t)=>t.score-e.score);t.forEach(t=>{const o=document.createElement('div');o.className='player-card',o.dataset.id=t.id,t.isEliminated&&o.classList.add('is-eliminated'),t.id===gameState.hostId&&o.classList.add('is-host'),o.innerHTML=`<div class="player-name">${t.name}</div><div class="player-score">${t.score}</div>`,e.appendChild(o)})}
        function renderResults(){const e=gameState.lastRoundResult;targetNumber.textContent=e.target,winnerName.textContent=e.winnerName,resultsList.innerHTML='';e.choices.forEach(t=>{const o=document.createElement('li');o.innerHTML=`<span>${t.playerName}</span><strong>${t.choice}</strong>`,resultsList.appendChild(o)}),e.eliminatedPlayers&&e.eliminatedPlayers.length>0?eliminationMessage.innerHTML=`<p style="color:var(--accent-color);">æœ¬å›åˆæ·˜æ±°: ${e.eliminatedPlayers.join(', ')}</p>`:eliminationMessage.innerHTML='',nextRoundBtn.style.display=socket.id===gameState.hostId?'block':'none'}
        function renderScoreboard(){renderPlayerList(scoreboardList)}
        function renderGameOver(){const e=Object.values(gameState.players).find(e=>!e.isEliminated);finalWinner.textContent=e?e.name:'ç„¡'}
        function createNumberGrid(){for(let e=0;e<=100;e++){const t=document.createElement('button');t.className='number-btn',t.textContent=e,t.dataset.number=e,t.addEventListener('click',()=>{t.disabled||(socket.emit('submitNumber',{roomCode:roomCode,number:e}),document.querySelectorAll('.number-btn').forEach(e=>e.disabled=!0),t.classList.add('selected'))}),numberGrid.appendChild(t)}}
        function resetNumberGrid(){document.querySelectorAll('.number-btn').forEach(e=>{e.disabled=!1,e.classList.remove('selected')})}
        function startClientTimer(e){let t=e;clearInterval(roundTimerInterval),roundTimerInterval=setInterval(()=>{t-=1e3;const e=Math.floor(t/1e3/60),o=Math.floor(t/1e3%60);timerDisplay.textContent=`${String(e).padStart(2,'0')}:${String(o).padStart(2,'0')}`,t<=0&&clearInterval(roundTimerInterval)},1e3)}
        function showNotification(e,t){notificationOverlay.textContent=e,notificationOverlay.classList.add('visible'),setTimeout(()=>{notificationOverlay.classList.remove('visible')},t)}
    });
    </script>
</body>
</html>
