<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>♦️K - 美人投票 (多人連線版)</title>
    <style>
        :root {
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --border-color: #444;
            --text-color: #e0e0e0;
            --accent-color: #e60000;
            --host-color: #ffd700;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1em;
            box-sizing: border-box;
        }
        #game-wrapper {
            width: 100%;
            max-width: 900px;
            background-color: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            padding: 2em;
            text-align: center;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #c40000; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        
        /* Lobby */
        #lobby-players {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .player-card {
            background-color: var(--primary-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .player-card.is-host .player-name::after {
            content: '👑';
            margin-left: 8px;
            color: var(--host-color);
        }
        .player-card.is-eliminated { opacity: 0.5; text-decoration: line-through; }
        .player-score { font-size: 1.5em; font-weight: bold; }
        #start-game-btn { margin-top: 20px; }

        /* Game */
        #timer { font-size: 2.5em; color: var(--accent-color); font-weight: bold; margin-bottom: 20px; }
        #number-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            max-width: 600px;
            margin: 0 auto;
        }
        .number-btn {
            background-color: #333;
            padding: 8px;
            font-size: 1em;
            border-radius: 4px;
        }
        .number-btn.selected { background-color: var(--host-color); color: #111; }
        .number-btn:disabled { background-color: #222; }

        /* Results & Scoreboard */
        #results-list, #scoreboard-list { list-style: none; padding: 0; max-width: 500px; margin: 20px auto; }
        #results-list li, #scoreboard-list li {
            background-color: var(--primary-bg);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            font-size: 1.2em;
        }

        /* Notifications */
        #notification-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: white;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        #notification-overlay.visible { opacity: 1; }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen active">
            <h1 id="lobby-title">等待玩家加入...</h1>
            <div id="lobby-players"></div>
            <button id="start-game-btn" disabled>等待主持人開始遊戲</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2 id="round-title"></h2>
            <div id="timer">03:00</div>
            <p>請選擇一個數字 (0-100)</p>
            <div id="number-grid"></div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h2>回合結果</h2>
            <p>目標數字: <strong id="target-number"></strong></p>
            <p>勝利者: <strong id="winner-name"></strong></p>
            <ul id="results-list"></ul>
            <div id="elimination-message"></div>
            <button id="next-round-btn">查看計分板</button>
        </div>

        <!-- Scoreboard Screen -->
        <div id="scoreboard-screen" class="screen">
            <h2>計分板</h2>
            <ul id="scoreboard-list"></ul>
            <p>10秒後將自動開始下一輪...</p>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <h2>遊戲結束</h2>
            <p>最終勝利者是: <strong id="final-winner"></strong></p>
        </div>
    </div>

    <div id="notification-overlay"></div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const screens = {
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen'),
            results: document.getElementById('results-screen'),
            scoreboard: document.getElementById('scoreboard-screen'),
            gameOver: document.getElementById('game-over-screen'),
        };
        
        // --- UI Elements ---
        const lobbyTitle = document.getElementById('lobby-title');
        const lobbyPlayers = document.getElementById('lobby-players');
        const startGameBtn = document.getElementById('start-game-btn');
        const roundTitle = document.getElementById('round-title');
        const timerDisplay = document.getElementById('timer');
        const numberGrid = document.getElementById('number-grid');
        const targetNumber = document.getElementById('target-number');
        const winnerName = document.getElementById('winner-name');
        const resultsList = document.getElementById('results-list');
        const eliminationMessage = document.getElementById('elimination-message');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const scoreboardList = document.getElementById('scoreboard-list');
        const finalWinner = document.getElementById('final-winner');
        const notificationOverlay = document.getElementById('notification-overlay');

        let roomCode = sessionStorage.getItem('gameRoomCode');
        let playerName = sessionStorage.getItem('playerName');
        let gameState = {};
        let roundTimerInterval;
        
        if (!roomCode || !playerName) {
            playerName = prompt("請輸入您的暱稱:") || `玩家${Math.floor(Math.random() * 1000)}`;
            roomCode = prompt("請輸入房間代碼加入或創建房間:") || "default";
            sessionStorage.setItem('playerName', playerName);
            sessionStorage.setItem('gameRoomCode', roomCode);
        }

        socket.emit('joinRoom', { roomCode, playerName });
        createNumberGrid();

        // --- Socket Listeners ---
        socket.on('updateGameState', (newState) => {
            gameState = newState;
            console.log("Game state updated:", gameState);
            updateUI();
        });

        socket.on('startRound', ({ round, duration }) => {
            roundTitle.textContent = `第 ${round} 回合`;
            startClientTimer(duration);
            resetNumberGrid();
        });
        
        socket.on('playerVoted', (playerId) => {
            const playerCard = lobbyPlayers.querySelector(`[data-id="${playerId}"]`);
            if (playerCard) {
                // You can add a visual indicator here
            }
        });
        
        socket.on('showAllVoted', () => {
            clearInterval(roundTimerInterval);
            showNotification("所有玩家已投票", 5000);
        });

        // --- Event Handlers ---
        startGameBtn.addEventListener('click', () => socket.emit('startGame', roomCode));
        nextRoundBtn.addEventListener('click', () => socket.emit('nextRound', roomCode));

        // --- UI Update Functions ---
        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }
        }
        
        function updateUI() {
            switch(gameState.status) {
                case 'LOBBY':
                    renderLobby();
                    switchScreen('lobby');
                    break;
                case 'PLAYING':
                    renderPlayerList(lobbyPlayers);
                    switchScreen('game');
                    break;
                case 'RESULTS':
                    renderResults();
                    switchScreen('results');
                    break;
                case 'SCOREBOARD':
                    renderScoreboard();
                    switchScreen('scoreboard');
                    break;
                case 'GAME_OVER':
                    renderGameOver();
                    switchScreen('gameOver');
                    break;
            }
        }

        function renderLobby() {
            lobbyTitle.textContent = `房間: ${roomCode} - 等待玩家...`;
            renderPlayerList(lobbyPlayers);
            if (socket.id === gameState.hostId) {
                startGameBtn.textContent = '開始遊戲';
                startGameBtn.disabled = Object.keys(gameState.players).length < 2; // 至少需要2人才能開始
            } else {
                startGameBtn.textContent = '等待主持人開始遊戲';
                startGameBtn.disabled = true;
            }
        }
        
        function renderPlayerList(container) {
            container.innerHTML = '';
            const players = Object.values(gameState.players).sort((a,b) => b.score - a.score);
            players.forEach(p => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.dataset.id = p.id;
                if(p.isEliminated) card.classList.add('is-eliminated');
                if(p.id === gameState.hostId) card.classList.add('is-host');
                card.innerHTML = `<div class="player-name">${p.name}</div><div class="player-score">${p.score}</div>`;
                container.appendChild(card);
            });
        }

        function renderResults() {
            const result = gameState.lastRoundResult;
            targetNumber.textContent = result.target;
            winnerName.textContent = result.winnerName;
            
            resultsList.innerHTML = '';
            result.choices.forEach(c => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${c.playerName}</span><strong>${c.choice}</strong>`;
                resultsList.appendChild(li);
            });

            if (result.eliminatedPlayers && result.eliminatedPlayers.length > 0) {
                eliminationMessage.innerHTML = `<p style="color:var(--accent-color);">本回合淘汰: ${result.eliminatedPlayers.join(', ')}</p>`;
            } else {
                eliminationMessage.innerHTML = '';
            }

            nextRoundBtn.style.display = (socket.id === gameState.hostId) ? 'block' : 'none';
        }
        
        function renderScoreboard() {
            renderPlayerList(scoreboardList); // Can reuse the function
        }
        
        function renderGameOver() {
            const winner = Object.values(gameState.players).find(p => !p.isEliminated);
            finalWinner.textContent = winner ? winner.name : '無';
        }

        // --- Helper Functions ---
        function createNumberGrid() {
            for (let i = 0; i <= 100; i++) {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = i;
                btn.dataset.number = i;
                btn.addEventListener('click', () => {
                    if (btn.disabled) return;
                    socket.emit('submitNumber', { roomCode, number: i });
                    
                    document.querySelectorAll('.number-btn').forEach(b => b.disabled = true);
                    btn.classList.add('selected');
                });
                numberGrid.appendChild(btn);
            }
        }
        
        function resetNumberGrid() {
             document.querySelectorAll('.number-btn').forEach(b => {
                 b.disabled = false;
                 b.classList.remove('selected');
             });
        }

        function startClientTimer(duration) {
            let timeLeft = duration;
            clearInterval(roundTimerInterval);
            roundTimerInterval = setInterval(() => {
                timeLeft -= 1000;
                const minutes = Math.floor((timeLeft / 1000) / 60);
                const seconds = Math.floor((timeLeft / 1000) % 60);
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (timeLeft <= 0) {
                    clearInterval(roundTimerInterval);
                }
            }, 1000);
        }

        function showNotification(message, duration) {
            notificationOverlay.textContent = message;
            notificationOverlay.classList.add('visible');
            setTimeout(() => {
                notificationOverlay.classList.remove('visible');
            }, duration);
        }
    });
    </script>
</body>
</html>
